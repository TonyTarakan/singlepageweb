<!doctype html>
<html lang="ru">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<style>
	html
	{
		color:rgba(0,0,0,0.7);
		font-family:Arial,Helvetica,Sans-Serif;
	}
	body
	{
		margin:0;
		padding:0;
		background-color:#f5f5f5
	}	
	h1,h2
	{
		margin:0;padding:0
	}
	.content
	{
		-moz-user-select: none;
		-khtml-user-select: none;
		user-select: none;
		display:block;
		height:100%
	}
	.header
	{
		height:150px;
		width:100%;
		display:table;
		margin-bottom:3rem;
		box-shadow:0 2px 10px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2);
		position:relative
	}
	.header-body
	{
		vertical-align:middle;
		display:table-cell
	}
	.footer
	{
		height:150px;
	}
	.title
	{
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		justify-content:center;
		text-align:center
	}
	.title-logo
	{
		padding-top:10px;
		display:flex;
		height:50px;
		flex-direction:row;
		flex-wrap:nowrap;
		justify-content:center
	}
	.title-wrapper
	{
		display:table;
	}
	.title-text
	{
		vertical-align:middle;
		display:table-cell;
		font-size:2rem;
		color:#003;
		padding-top:10px
	}
	.content-body
	{
		width:90%;
		height:100%;
		margin:0 auto;
		text-align:center
	}
	.section-row
	{
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		width:100%
	}
	.section
	{
		margin-left:1rem;
		margin-right:1rem;
		flex:1;
		background-color:#fff;
		-webkit-transition:box-shadow .3s ease-in-out 0;
		-moz-transition:box-shadow .3s ease-in-out 0;
		-o-transition:box-shadow .3s ease-in-out 0;
		-ms-transition:box-shadow .3s ease-in-out 0;
		transition:box-shadow .3s ease-in-out 0;
		box-shadow:0 2px 10px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2);
		margin-bottom:2rem
	}
	.section:hover
	{
		box-shadow:0 2px 20px 0 rgba(0,0,0,0.3),0 1px 5px 0 rgba(0,0,0,0.3),0 3px 1px -2px rgba(0,0,0,0.3)
	}
	.section-body
	{
		/*border-top:1px solid #f5f5f5;*/
		
		margin-top:-0.05rem;
		
		padding-bottom: 1rem;
		font-size:1.4rem;
		flex:1;
		background-color:#fff;
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		justify-content:center;
		width:100%
	}
	.tabsect
	{
		/*border-top:1px solid #f5f5f5;*/
		border-top:1px solid #C0C0C0;
		padding-top: 1rem;
		margin-top:-0.05rem;
		display:flex;
		flex-direction:column;
		flex-wrap:nowrap;
		justify-content:center;
		width:100%
	}
	.dates input,button
	{
		margin-bottom: 0.5em;
		outline: none;
		background: #fff;
		border:1px solid #00a5cd;
		font-size: 16px;
		padding-left: 10px;
		padding-right: 10px;
		-webkit-border-radius: 5px;
		-moz-border-radius: 5px;
		border-radius: 5px;
		color:#00a5cd;
	}
	.dates button {
		padding: 10px;
		width: 100px;
		text-align:center;
	}
	.dates button:active {
    	box-shadow:0 2px 20px 0 rgba(0,0,0,0.3),0 1px 5px 0 rgba(0,0,0,0.3),0 3px 1px -2px rgba(0,0,0,0.3)
	}
	.ss
	{
		display:flex;
		flex-direction:row;
		justify-content:center;
		margin-left:0.5rem;
		margin-right:0.5rem
	}
	.sss
	{
		display:flex;
		justify-content:center;
		flex-direction:column;
		text-align:left;
		white-space: nowrap;
	}
	.direc {
		flex-direction:row !important; 
	}
	.ssss
	{
		min-width:140px
	}
	.section h2
	{
		padding-top:.5rem;
		padding-bottom:.5rem;
		color:#00a5cd;
		font-weight:400;
		/*border-bottom:1px solid #f5f5f5*/
	}
	.conic:hover
	{
		opacity: 0.3;
	}
	.chartBar
	{
		fill:steelblue;
		stroke:black;
		stroke-width:0.1;
		stroke-opacity:0.1;
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		display: flex;
		justify-content:center;
	}
	.barch
	{
		width:100%;
		height:400px;
		font-size:1.4rem;
		fill:#00a5cd
	}
	.barcht
	{
		/*border-top: 1px solid #C0C0C0;*/
		padding: 0.4rem;
		font-size:1.4rem;
		/*width: 250px;
		display:inline-block;*/
	}



.tabs>input { display:none; }
.tabs>div {
	display:none;
	cursor: pointer;
	/*visibility: hidden;*/
}
.tabs>label {
    padding-top: 7px;
    padding-bottom: 7px;
    text-align: center;
    color: #666666;
    border: 1px solid #C0C0C0;
    /*border-bottom: none;*/
    background: #E0E0E0;
    cursor: pointer;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    display:inline-block;
	width:48%
}
.tabs>input:checked + label {
    color: #000000;
    border-bottom: 1px solid #fff;
    background: #FFFFFF;
    /*box-shadow:-2px -2px 6px 0 rgba(0,0,0,0.3),2px -2px 6px 0 rgba(0,0,0,0.3);*/
}
#tab_1:checked ~ #txt_1,
#tab_2:checked ~ #txt_2{ display: flex; }













	@media only screen and (max-width: 600px)
	{
		.section-row
		{
			flex-direction:column;
			flex-wrap:nowrap;
			justify-content:center;
			width:100%
		}
		.section
		{
			flex-direction:column;
		}
		.title-text
		{
			font-size:1.5rem
		}
		.section-body
		{
			font-size: 1.4rem;
			padding-top:0.4rem;
			padding-bottom:0.4rem;
			flex-direction:column;
			flex-wrap:nowrap;
			width:100%
		}
		.section h2
		{
			font-size:1.0rem
		}
		.barch
		{
			height:200px;
			font-size:0.8rem
		}
		.barcht
		{
			font-size:1.1rem;
		}
		.direc {
			flex-direction:column !important;
		}
	}
	@media only screen and (min-width: 600px) and (max-width: 768px)
	{
		.section h2
		{
			font-size:1.2rem
		}
		.barch
		{
			height:300px;
			font-size:1rem
		}
		.sss
		{
			font-size:1.2rem
		}
		.ssss
		{
			min-width:105px
		}
	}






	</style>

	<title>AS100</title>



	<script type="text/javascript">


		elAttr = {
			width: 'width',
			height: 'height',
			id: 'id',
			class: 'class',
			undefined: 'undefined'
		};

		fnSvgElement = {
			newElement: 'undefined',
			createNewElement: function (element) {
				this.newElement = document.createElementNS("http://www.w3.org/2000/svg", element);
				return this;
			},
			addAttribute: function (key, value) {
				if (this.newElement !== 'undefined')
					this.newElement.setAttribute(key, value);
				else {
					throw Error();
				}
				return this;
			},
			toDomString: function () {
				return this.newElement;
			}
		};

		newObj = {
			bar:function() {
				var b = Object.assign({},elBar);
				return b;
			}
		};

		elUtil = {
			calcTot: function (data) {
				var tot = data.reduce(function (previousValue, currentValue) {
					return previousValue + currentValue;
				});
				return tot;
			},
			getPosition: function (el) {
				var rect = el.getBoundingClientRect(),
						scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
						scrollTop = window.pageYOffset || document.documentElement.scrollTop;
				return {x: rect.top + scrollTop, y: rect.left + scrollLeft};
			},
			getSubArray:function(arr,start,end) {
				return arr.slice(start,end+1);
			}
		};

		elStats = {
			calcRangeOnNonSortedData: function (arr) {
				arr.sort(function(a,b){
					return a-b;
				});
				var len = arr.length;
				var range = (arr[len-1] - arr[0]) / (len-1);
				return Math.ceil(range);
			}
		};

		set = {
			bar: function(x,y,id,barWidth,barHeight,barClass) {
				var bar = fnSvgElement.createNewElement('rect')
						.addAttribute('x', x)
						.addAttribute('y', y)
						.addAttribute('id', id)
						.addAttribute('width', barWidth)
						.addAttribute('height', barHeight)
						.addAttribute('class', barClass)
						.toDomString();
				return bar;
			}
		};

		function generateArcSector(svg, cX, cY, radius, datum, colour, iniA, endA, sweep) {
			cX = parseFloat(cX);
			cY = parseFloat(cY);
			radius = parseFloat(radius);
			iniA = parseFloat(iniA);
			var x1 = cX + radius * Math.cos((iniA) * Math.PI / 180);
			var y1 = cY + radius * Math.sin((iniA) * Math.PI / 180);

			var x2 = cX + radius * Math.cos((endA) * Math.PI / 180);
			var y2 = cY + radius * Math.sin((endA) * Math.PI / 180);


			var path = 'M' + cX + ' ' + cY +   ' L' + x1 + ' ' + y1 +	' A' + radius + ' ' + radius + ', 0, ' + sweep + ', 1, ' + x2 + ' ' + y2 + ' z';
			var pathNode = fnSvgElement.createNewElement('path')
					.addAttribute('d', path)
					.addAttribute('stroke-width', '0.1')
					.addAttribute('class', 'conic')
					.addAttribute('stroke', 'black')
					.addAttribute('fill', colour)
					.toDomString();
			var title = fnSvgElement.createNewElement('title').toDomString();
			title.textContent = datum + '%';
	 		pathNode.appendChild(title);

	 		svg.appendChild(pathNode);
		}

		elException = {
			generalCheck: function (actual, expected) {
				if (actual === expected) {
					return !0;
				} else {
					return !1;
				}
			},
			checkId: function (id) {
				if (this.generalCheck(id, null)) {
					throw Error();
				} else {
					return !0;
				}
			},
			checkObject: function (obj) {
				if (this.generalCheck(obj, elAttr.undefined)) {
					throw Error();
				} else {
					return !0;
				}
			}
		};

		elPie = {
			svgObject: 'undefined',
			properties: {
				width: '',
				height: '',
				data: [],
				colours: []
			},
			create: function (eleId) {
				var div = document.getElementById(eleId);
				if (elException.checkId(div)) {
					this.svgObject = fnSvgElement.createNewElement('svg')
				   			.addAttribute('width', this.properties.width)
							.addAttribute('height', this.properties.height)
							.toDomString();
					div.appendChild(this.svgObject);
					return this;
				} else {
					throw Error();
				}
			},
			generate: function () {
				var ht = parseInt(this.properties.height);
				var wt = parseInt(this.properties.width);
				var tot = elUtil.calcTot(this.properties.data);
				var radius = 0.9* (2*ht) / 4;
				var len = this.properties.data.length;
				var iniA = 0;
				var endA = 0;
				var cx = wt / 2;
				var cy = ht / 2;
				var sweep, d, v;
				gobj = fnSvgElement.createNewElement('g').toDomString();

				for (var i = 0; i < len; i++) {
					d = this.properties.data[i];

					v = ((360 * d) / tot);
					if (v > 359.999) v = 359.999;
					//console.log(i, v);

					endA = iniA + v;
					
					if (d > (tot / 2)) sweep = 1;
			   		else sweep = 0;

					generateArcSector(gobj, cx, cy, radius, (d/tot*100).toFixed(3), this.properties.colours[i], iniA, endA, sweep);


					//generateArcSector(gobj, cx, cy, radius, (this.properties.data[i]/tot*100).toFixed(3), this.properties.colours[i], iniA, endA, sweep);



					iniA = endA;

				}
				this.svgObject.appendChild(gobj);
			},
			attribute: function (attr, value) {
				elException.checkObject(this.svgObject);
				this.properties[attr] = value;
				this.svgObject.setAttribute(attr, value);
				return this;
			},
			data: function (dt) {
				elException.checkObject(this.svgObject);
				this.properties.data = dt;
				this.generate();
				return this;
			}
		};

		svg = {
			svgObj: 'undefined',
			generate: function (height, width) {
				this.svgObj = fnSvgElement.createNewElement('svg')
						.addAttribute('width', width)
						//.addAttribute('height', height)
						//.addAttribute('preserveAspectRatio', "none") ???
						.addAttribute('class', 'barch')
						.toDomString();
				return this.svgObj;
			}
		};

		axis = {
			props: {
				'SX': 0,
				'SY': 0,
				'OX': 0,
				'OY': 0,
				'EX': 0,
				'EY': 0,
				'LOX': 0,
				'': '',
				'xdataRotation': 90,
				'xCords': [],
				'yCords': [],
				'yAxPos': [],
				'baseUnit' : 0
			},
			generateAxis: function (level, color, text) {

				//console.log(this.props.SY , this.props.OY);
				var xPath = pathG.move(this.props.SX + this.props.LOX/2, 0) + ' ' + pathG.lineTo(this.props.SX + this.props.LOX/2, this.props.OY+10);
	        pathObj = fnSvgElement.createNewElement('path')
	                .addAttribute('d', xPath)
	                .addAttribute('stroke-width', '0.5')
	                .addAttribute('class', 'xAxis')
	                .addAttribute('stroke', 'black')
	                .addAttribute('fill', 'none')
	                .toDomString();
	        this.props.svg.appendChild(pathObj);



				var yPath = pathG.move(this.props.OX, this.props.OY-level) + ' ' + pathG.lineTo(this.props.EX, this.props.EY-level);
				pathObj = fnSvgElement.createNewElement('path')
						.addAttribute('d', yPath)
						.addAttribute('stroke-width', '1')
						.addAttribute('stroke', color)
						.toDomString();
				this.props.svg.appendChild(pathObj);
				if(text) {
					var titlet = fnSvgElement.createNewElement('text')
												.addAttribute('x', this.props.OX)
												.addAttribute('y', this.props.OY-level-5)
												.addAttribute('class', 'barch')
												.toDomString();
												titlet.textContent = this.props.yAxPos + ' Вт';
					this.props.svg.appendChild(titlet);
				}
			},
			calculateAxis: function (width, height) {
				
				var startX = this.props.SX = 0.05*width;
				var startY = this.props.SY = 0.08*height;
				this.props.OX = startX;
				var oY = this.props.OY = height - 0.02*height;
				var endX = this.props.EX = width - startX;
				this.props.EY = oY;
				this.props.LOX = endX - startX;

				var ycords = this.props.yCords;
				var length = ycords.length;
				var range = elStats.calcRangeOnNonSortedData(ycords);
				if(range == 0) {
					this.props.yAxPos = 0;
					this.props.aDiff = 0;
					return;
				}
				var max = Math.ceil(ycords[length - 1]);
				this.props.yAxPos = max;
				//console.log(max, range);
				var a_diff = (oY - startY) / (max / range);
				//console.log("a_diff",a_diff);
				this.props.aDiff = a_diff/range;
				//console.log("this.props.aDiff",this.props.aDiff);
			},
			generateSimpleAxis: function (svgObj, xcords, ycords, yticks, xdataR, height, width) {
				width = document.getElementById("bar").clientWidth;
				height = document.getElementById("bar").clientHeight;
				this.props.svg = svgObj;
				this.props.xCords = xcords;
				this.props.yCords = ycords;
				this.props.xdataRotation = xdataR;
				this.calculateAxis(width, height);
				this.generateAxis(0, 'black');
				for (var i = 4; i > 0; i--) {
					this.generateAxis(this.props.yAxPos*i*this.props.aDiff/4, '#00a5cd', !(i%4))
				}
			}
		};

		pathG = {
			move: function (x, y) {
				return 'M' + x + ',' + y;
			},
			lineTo: function (x, y) {
				return 'L' + x + ',' + y;
			},
			completePath: function () {
				return 'z';
			}
		};

		chart = {
			pie: function (id, props) {
				for (var i in props) {
					elPie.properties[i] = props[i];

				}
				elPie.create(id);
				elPie.generate();
			},
			bar: function (id, props) {
				var bar = newObj.bar();
				
				for (var i in props) {
					bar.props[i] = props[i];
				}
				bar.generate(id);
			}
		};

		var barprops = {			
			'data': [],
			'xCords': [],
			'yCords': [],
			'yCordsSorted': [],
			'datumsPerScreen': 11,
			'colours': {},
			'barColours': '',
			'yTickLabels': {},
			'start': 42, // hardcoded draw area (48-datumsPerScreen)
			'svgObj': 'undefined',
			'axisType': 'generateSimpleAxis'
		};

		elBar = {
			props: {
				'width': 0,
				'height': 0,
				'data': [],
				"time": 0,
				'xCords': [],
				'yCords': [],
				'yCordsSorted': [],
				'datumsPerScreen': 4,
				'colours': {},
				'barColours': 'blue',
				'yTickLabels': {},
				'svgObj': 'undefined',
				'prevBar': 'undefined',
				'axisType': 'generateSimpleAxis',
				'aProps': {},
				'prevPos': 0,
				'presentPos': 0,
				'grag' : false,
				'veloc' : 0,
				'start':0,
				'end':0,
				'length':0,
				'groupBar':'undefined'

			},
			removeBars:function() {
				var group = document.getElementsByClassName('bargroup')[0];
			},
			move:function() {
				if(elBar.props.prevPos!=0) {
					var diff = elBar.props.presentPos - elBar.props.prevPos;					

					var thres = elBar.props.aProps.LOX/elBar.props.datumsPerScreen;
					//console.log(thres);
					if(diff<-12 && elBar.props.start+elBar.props.datumsPerScreen/2+1 < elBar.props.length) {
						elBar.props.start = elBar.props.start+1;
						elBar.props.end = elBar.props.end+1;
						elBar.props.svgObj.removeChild(elBar.props.groupBar);
						elBar.generateBars(elBar.props.start+1,elBar.props.start+elBar.props.datumsPerScreen);
						elBar.props.prevPos = elBar.props.presentPos;
					}
					if(diff>12 && elBar.props.start > -elBar.props.datumsPerScreen/2+1) {
						elBar.props.start= elBar.props.start-1;
						elBar.props.end = elBar.props.end-1;
						elBar.props.svgObj.removeChild(this.props.groupBar);
						elBar.generateBars(elBar.props.start+1,elBar.props.start+elBar.props.datumsPerScreen);
						elBar.props.prevPos = elBar.props.presentPos;
					}
				}
				else
					elBar.props.prevPos = elBar.props.presentPos;
				barprops.start = elBar.props.start;
				barprops.end = elBar.props.end;
			},
			dragSvg : function(event) {
				if(event) {
					if(event.buttons!=0) {
						if ('ontouchstart' in window)
							elBar.props.presentPos = event.touches[0].clientX; 
						else
							elBar.props.presentPos = event.screenX;

						elBar.props.veloc = elBar.props.presentPos-elBar.props.prevPos;

						elBar.move();
					}
				}
				else
				{
					//console.log("dragSvg timeout !!!");
					//console.log(elBar.props.veloc);
					
					elBar.props.presentPos = elBar.props.prevPos + elBar.props.veloc;
					elBar.props.veloc*=0.9;
					elBar.move();

					if(elBar.props.veloc > 12 || elBar.props.veloc < -12) {
						setTimeout(elBar.dragSvg, 50/Math.pow(Math.abs(elBar.props.veloc),0.2));
					}
				}
			},
			mousedown : function(event) {
				//this.props.down=true;
				if ('ontouchstart' in window)
					this.props.prevPos = event.touches[0].clientX;
				else
					this.props.prevPos = event.screenX;

				this.props.drag = true;
				document.getElementById("bar").innerHTML = "";
				chart.bar('bar', barprops);
				return false;
			},
			mouseup : function(event) {
				this.props.drag = false;
				//console.log("dragSvg timeo");
				setTimeout(this.dragSvg, 50);
				return false;
			},
			generateBars : function(start,end) {
				var LOX = this.props.aProps.LOX;
				var oX =  this.props.aProps.OX;
				var oY =  this.props.aProps.OY;
				var bps = end-start+1;
				var svg = this.props.svgObj;
				var barWidth =  3*LOX/(4*bps);
				var distBtwBar = LOX/(4*bps);
				var x = oX+distBtwBar/2;
				var y = oY;
				var group = fnSvgElement.createNewElement('g')
							.addAttribute('class','bargroup')
							.toDomString();

				for(var i=start;i<=end;i++) {
					var barHeight = ((parseFloat(this.props.yCords[i-1])-this.props.aProps.baseUnit)*this.props.aProps.aDiff);
					if(barHeight == 0) barHeight = 2;
					if(isNaN(barHeight)) barHeight = 0;
					barPosition = oY-barHeight;
					var bar = set.bar(x,barPosition,'b'+i,barWidth,barHeight,'chartBar');

					/*var titlet = fnSvgElement.createNewElement('text')
											.addAttribute('id','tt'+i )
											.addAttribute('x', x)
											.addAttribute('y', barPosition)
											.addAttribute('position', 'relative')
											.addText(this.props.xCords[i-1] + ' - ' + this.props.yCords[i-1] + ' Вт')
											.addAttribute('class','tooltip')
											.addAttribute('font-family','Arial')
											.addAttribute('font-size',20)
											.addAttribute('visibility','hidden')
											.toDomString();*/

					
					var title = fnSvgElement.createNewElement('title').toDomString();
					title.textContent = this.props.xCords[i-1] + ' - ' + this.props.yCords[i-1] + ' Вт';
					bar.appendChild(title);

					// CAN BE OPTIMISED
					if(i == parseInt((end+start)/2)) {
						bar.style.opacity = 0.7;
						bar.style.fill = '#F2635F';
						var td = document.getElementById("tdata");
						td.textContent = bar.firstChild.textContent;
					}

			 		//group.appendChild(titlet);

					bar.addEventListener('mousedown', this.mousedown.bind(this));
					bar.addEventListener('mouseup', this.mouseup.bind(this));
					if ('ontouchstart' in window) {
						bar.addEventListener('touchstart', this.mousedown.bind(this));
						bar.addEventListener('touchend', this.mouseup.bind(this));
					}
					//"var tt = document.getElementById(\"tt"+i+"\"); tt.style.x = event.screenX; tt.style.y = event.screenY;tt.style.visibility='visible';"); // this.firstChild.style.visibility='visible'


			 		group.appendChild(bar);

			 		x=x+barWidth+distBtwBar;
				}

				

				this.props.groupBar = group;
				svg.appendChild(group);
			},
			generate: function (id, properties) {

				delete document.getElementById(id);
				for (var i in properties) {
					this.props[i] = properties[i];
				}
				var data = this.props['data'];
				var xCords = [];
				var yCords = [];

				var d = new Date(this.props['time']*1000);
				d.setMinutes( Math.floor(d.getMinutes()/30)*30 );
				d.setDate(d.getDate() - 1);

				for ( var i = 0; i < data.length; i++ ) {


					var hours1 = d.getHours();
					var minutes1 =  parseInt( ("0" + d.getMinutes()).substr(-2) );

					d.setMinutes(d.getMinutes() + 30);
					
					var hours = d.getHours();
					var minutes =  parseInt( ("0" + d.getMinutes()).substr(-2) );

					var date = data[i].ts;
					xCords.push(date.substr(8, 2) + "/" + date.substr(5, 2) + "/" + date.substr(0, 4) + " " + date.substr(11, 5));
					yCords.push(data[i].val*2);

					
				}
				//console.log(yCords);
				this.props.xCords = xCords;
				this.props.yCords = yCords;
				this.props.length = yCords.length;
				this.props.yCordsSorted = Object.assign([],yCords);
				this.props.svgObj = svg.generate(this.props.height, this.props.width);
				window['axis'][this.props.axisType](this.props.svgObj, xCords, this.props.yCordsSorted,[],0, this.props.height, this.props.width); 
				document.getElementById(id).appendChild(this.props.svgObj);
				this.props.aProps = axis.props;
				//console.log(barprops.start);
				this.generateBars(barprops.start+1, barprops.start+this.props.datumsPerScreen);
				//this.props.start=barprops.start+1;
				//console.log(barprops.start, "to", barprops.start+this.props.datumsPerScreen);
				this.props.end=this.props.datumsPerScreen;
				this.props.svgObj.addEventListener('mousemove',this.dragSvg.bind(this));
				this.props.svgObj.addEventListener('mousedown',this.mousedown.bind(this));
				this.props.svgObj.addEventListener('mouseup',this.mouseup.bind(this));
				if ('ontouchstart' in window) {
					this.props.svgObj.addEventListener('touchmove',this.dragSvg.bind(this));
					this.props.svgObj.addEventListener('touchstart',this.mousedown.bind(this));
					this.props.svgObj.addEventListener('touchend',this.mouseup.bind(this));
				}
			}
		}; 



		var error_counter = 0;
		var req_counter = 999999;
		var needBar = false;
		var pieh;

		String.prototype.format = function() {
			var formatted = this;
			for( var arg in arguments )
				formatted = formatted.replace("{" + arg + "}", arguments[arg]);

			return formatted;
		};

		function clearPD() {
			document.getElementById("penvt").innerHTML  = "";
			document.getElementById("penv1").innerHTML  = "";
			document.getElementById("penv2").innerHTML  = "";
			document.getElementById("penv3").innerHTML  = "";
			document.getElementById("penv4").innerHTML  = "";
			document.getElementById("pent").innerHTML  = "";
			document.getElementById("pen1").innerHTML  = "";
			document.getElementById("pen2").innerHTML  = "";
			document.getElementById("pen3").innerHTML  = "";
			document.getElementById("pen4").innerHTML  = "";
			document.getElementById("ppie").innerHTML  = "";
			document.getElementById("pieper").style.height = 0;
		};

		function get_data(success, success1, error, timeout, period) {
			var rs = '/api/v1/';
			if(!needBar) {
				var param = "";
				var err = false;

				if(period) {
					if(!document.getElementById('dfrom').value) {
						document.getElementById('dfrom').style.border = "1px solid red";
						clearPD();
						err = true;
					}
					else document.getElementById('dfrom').style.border = "1px solid #00a5cd";
					if(!document.getElementById('dto').value) {
						document.getElementById('dto').style.border = "1px solid red";
						clearPD();
						err = true;
					}
					else document.getElementById('dto').style.border = "1px solid #00a5cd";
					if(err) return;
					if(document.getElementById('dto').value <= document.getElementById('dfrom').value) {
						clearPD();
						document.getElementById('dfrom').style.border = "1px solid red";
						document.getElementById('dto').style.border = "1px solid red";
						err = true;
					}
					if(err) return;
					document.getElementById("pieper").style.height = pieh;


					param = param + "?from=" + document.getElementById('dfrom').value + "&to=" + document.getElementById('dto').value;
				}
				var xmlhttp = new XMLHttpRequest();

				xmlhttp.open('GET', rs+"get"+param, true);

				xmlhttp.timeout = timeout || 2000;

				xmlhttp.onreadystatechange = function() {
					if (xmlhttp.readyState == XMLHttpRequest.DONE) {
						if(xmlhttp.status == 200) {
							try {
								success(JSON.parse(xmlhttp.responseText));
								/*if(period) success(JSON.parse( "{\"SN\":\"TEST0000\", \"T\":1508430088, \"A1\":0.001, \"A2\":0.100, \"A3\":0.100, \"A4\":0.100}" ));
								else success(JSON.parse( "{\"SN\":\"TEST0000\", \"T\":1508430088, \"A1\":4455.001, \"A2\":45455.100, \"A3\":155455.100, \"A4\":565461.100,\"P\":123.65, \"U\":220.14 }" ));*/
								
							}
							catch (E) {
								error("Fail to parse json get");
								console.log("Fail to parse json get");
							}
						}
						else {
							error(xmlhttp.responseText);
							console.log("xmlhttp", xmlhttp.responseText);
						}

					}
				};
			
				xmlhttp.send(null);
			}

			
			else {

				var xmlhttp1 = new XMLHttpRequest();

				xmlhttp1.open('GET', rs+"lp", true);

				xmlhttp1.timeout = timeout || 2000;

				xmlhttp1.onreadystatechange = function() {
					if (xmlhttp1.readyState == XMLHttpRequest.DONE) {
						if(xmlhttp1.status == 200) {
							try {
								success1(JSON.parse(xmlhttp1.responseText));
								needBar = false;
								/*success1(JSON.parse( "{\"lp\":[5, 2, 34, 4, 33, 0.5, 5, 6, 2, 23, 0, 0, 0, 5, 6, 9, 9, 5, 1, 9, 10, 1, 1, 5, 1, 4, 5, 6, 2, 3, 5, 6, 2, 5, 6, 9, 9, 5, 1, 5, 8.451, 23.2, 3, 4, 35.1, 4, 5, 12]}" ));*/

								/*success1(JSON.parse( "[{\"ts\":\"2016-02-28T00:00:00+00:00\",\"d\":3600,\"val\":4554},{\"ts\":\"2016-02-28T01:00:00+00:00\",\"d\":3600,\"val\":456},{\"ts\":\"2016-02-28T02:00:00+00:00\",\"d\":3600,\"val\":231},{\"ts\":\"2016-02-28T03:00:00+00:00\",\"d\":3600,\"val\":6745},{\"ts\":\"2016-02-28T04:00:00+00:00\",\"d\":3600,\"val\":7857},{\"ts\":\"2016-02-28T05:00:00+00:00\",\"d\":3600,\"val\":456},{\"ts\":\"2016-02-28T06:00:00+00:00\",\"d\":3600,\"val\":836},{\"ts\":\"2016-02-28T07:00:00+00:00\",\"d\":3600,\"val\":231},{\"ts\":\"2016-02-28T08:00:00+00:00\",\"d\":3600,\"val\":8788},{\"ts\":\"2016-02-28T09:00:00+00:00\",\"d\":3600,\"val\":798},{\"ts\":\"2016-02-28T10:00:00+00:00\",\"d\":3600,\"val\":5458},{\"ts\":\"2016-02-28T11:00:00+00:00\",\"d\":3600,\"val\":785},{\"ts\":\"2016-02-28T12:00:00+00:00\",\"d\":3600,\"val\":857},{\"ts\":\"2016-02-28T13:00:00+00:00\",\"d\":3600,\"val\":4564},{\"ts\":\"2016-02-28T14:00:00+00:00\",\"d\":3600,\"val\":2525},{\"ts\":\"2016-02-28T15:00:00+00:00\",\"d\":3600,\"val\":1232},{\"ts\":\"2016-02-28T16:00:00+00:00\",\"d\":3600,\"val\":8787},{\"ts\":\"2016-02-28T17:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-28T18:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-28T19:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-28T20:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-28T21:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-28T22:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-28T23:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T00:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T01:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T02:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T03:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T04:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T05:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T06:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T07:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T08:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T09:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T10:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T11:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T12:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T13:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T14:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T15:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T16:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T17:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T18:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T19:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T20:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T21:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T22:00:00+00:00\",\"d\":3600,\"val\":6666},{\"ts\":\"2016-02-29T23:00:00+00:00\",\"d\":3600,\"val\":6666}]" ));
								needBar = false;*/
								
							}
							catch (E) {
								error("Fail to parse json lp");
								console.log("Fail to parse json lp");
							}
						}
						else {
							error(xmlhttp1.responseText);
							console.log("xmlhttp1", xmlhttp1.responseText);
						}

					}
				};

				xmlhttp1.send(null);	
			}
		}

		function refreshData(period)
		{
			get_data(
				function(data) {
					//console.log("Refresh PIE");
					//console.log(document.getElementById('interv').value);
					var p = "";
					if(period) p = p + "p";

					error_counter = 0;
					req_counter++;
					if(req_counter > 29) {
						needBar = true;
						req_counter = 0;
					}
					document.getElementById("title").innerHTML="AS100 (#{0})".format(data.SN);

					var T1 = parseFloat(data.A1);
					var T2 = parseFloat(data.A2);
					var T3 = parseFloat(data.A3);
					var T4 = parseFloat(data.A4);

					var pp = {
						'width': 260,
						'height': 260,
						'data': [],
						'colours': ['#ff8678', '#ffbf00', '#4ec7ff', '#6ee7ff']
					};

					if(!isNaN(T1)) pp.data.push(T1);
					if(!isNaN(T2)) pp.data.push(T2);
					if(!isNaN(T3)) pp.data.push(T3);
					if(!isNaN(T4)) pp.data.push(T4);
					
					//barprops.time = parseInt(data.T);

					if(pp.data.length > 1)
					{
						var sum = 0;
						for (var i = 0; i < pp.data.length; i++) {
							sum += pp.data[i];
							document.getElementById( p+"en"+(i+1).toString() ).innerHTML  = "<span style='color:"+pp.colours[i]+"'>■</span> Тариф "+(i+1).toString();
							document.getElementById( p+"env"+(i+1).toString() ).innerHTML  = "{0}".format( pp.data[i].toFixed(1).toString() );
						}
						
						document.getElementById(p +"pie").innerHTML = "";
						if(sum != 0)
						{
							chart.pie(p +'pie', pp);
						}
						document.getElementById(p +"ent").innerHTML  = "○ Сумма";
						document.getElementById(p +"envt").innerHTML  = "{0}".format(sum.toFixed(1).toString());

					}
					else
					{	try {
							el = document.getElementById(p +"pies");
							el.parentNode.removeChild(el);
						} catch (e) {
							//console.log("1!");
						}
						document.getElementById(p +"envt").innerHTML = T1.toString();
					}
					
					if(!period) {
						document.getElementById("power").innerHTML	= data.P.toFixed(1).toString();
						document.getElementById("voltage").innerHTML  = data.U.toFixed(1).toString();

						setTimeout(refreshData, 2000);
					}
					
				},
				function(data) {
					error_counter = 0;
					for (var i in data) {
						barprops.data[i] = data[i];
					}
					document.getElementById("bar").innerHTML = "";
					chart.bar('bar', barprops);

					setTimeout(refreshData, 2000);
				},
				function(error) {
					if (error_counter > 3)
					{
						document.getElementById("title").innerHTML="AS100 (Нет cвязи)"; 
						document.getElementById("envt").innerHTML  = "";
						document.getElementById("env1").innerHTML  = "";
						document.getElementById("env2").innerHTML  = "";
						document.getElementById("env3").innerHTML  = "";
						document.getElementById("env4").innerHTML  = "";
						document.getElementById("ent").innerHTML  = "";
						document.getElementById("en1").innerHTML  = "";
						document.getElementById("en2").innerHTML  = "";
						document.getElementById("en3").innerHTML  = "";
						document.getElementById("en4").innerHTML  = "";
						document.getElementById("pie").innerHTML  = "";
						clearPD();
						document.getElementById("tdata").innerHTML  = "";
						document.getElementById("bar").innerHTML  = "";
						document.getElementById("power").innerHTML	= "";
						document.getElementById("voltage").innerHTML  = "";
					}
					else
					{
						error_counter += 1;
					}
					
					setTimeout(refreshData, 3000);
				},
				2000,
				period
			);
			//elBar.mouseup();
		}

		

		window.onload = function()
		{
			pieh = document.getElementById("pieper").style.height;
			clearPD();
			refreshData();
		};

		window.onresize = function()
		{
			var cb = document.getElementById("bar").innerHTML = "";
			chart.bar('bar',cb.barprops);
		}

		

	</script>
</head>

<body>
	<div class="content">
		<div class="header">
			<div class="header-body">
				<div class="title-logo">
					<svg class="title-logo" viewBox="0 0 77.59 14.65"><g fill="#b01842"><path d="M39.63 7.23c0-2.5-1.88-4.52-4.48-4.53h-.02c-2.6 0-4.46 2.15-4.46 4.66 0 2.5 1.84 4.48 4.46 4.48 2 0 4.17-.9 4.45-2.74h-1.55c-.32 2.1-4.02 2.07-4.15.05-.02-.34-.02-1.27-.02-1.27h5.8c.02-.17-.03-.46-.03-.65zm-5.74-.5V5.2s0-1.4 1.2-1.4c1 0 1.1 1.47 1.1 1.47v1.5h-2.3zM69.9 0h3.23v11.43H70zm4.38 0h3.24v11.43H74.3zM15.4 2.7c-1.64 0-4.7 1.16-4.7 4.6.02 3.8 3.06 4.54 4.7 4.54 1.64 0 4.7-.96 4.7-4.55-.02-3.6-3.06-4.6-4.7-4.6zm0 8.03c-.9 0-1.22-1.36-1.22-3.43 0-2.08.18-3.47 1.22-3.47.98 0 1.18 1.4 1.18 3.47 0 2.07-.2 3.43-1.18 3.43zM0 0h3.5v4.7h2.72V0h3.7v11.43H6.2V6.4H3.5v5.05H0V0m21.08 11.43v-8.4h3.2v.8s1.15-.96 2.54-.96c1.3 0 2.5.9 2.76 1.92.08.3.06.6.06.6v6H26.5V5.9s.12-1.25-.84-1.2c-.76.04-1.26.44-1.4.7v6.05H21.1"/><path d="M38.84 12.8c0 .75.44 1.85 1.85 1.85 1.1 0 2.2-.66 2.6-1.57l4-10.04 2.4 8.4h2.63L53.7 6.4l1.6 5.1h2.5L60 3.1h-1.4l-1.16 4.4-1.5-4.4h-2.6l-1.3 4.5-1.33-4.53h-4.6L44.5 7.1l-1.54-4.05h-3.7s3.42 7.8 3.4 8.4c-.04 1.38-1.1 2-1.24 2.05h.02c.12-.17.23-.5.23-.78 0-.77-.62-1.4-1.4-1.4-.77 0-1.4.64-1.4 1.48M69.2 7.23c0-2.5-1.9-4.52-4.5-4.53-2.6 0-4.46 2.15-4.46 4.66 0 2.5 1.84 4.48 4.46 4.48 1.98 0 4.16-.9 4.44-2.74H67.6c-.33 2.1-4.03 2.07-4.16.05-.02-.34-.02-1.27-.02-1.27h5.8c.02-.17-.03-.46-.03-.65zm-5.74-.5l.06-1.52s0-1.4 1.2-1.4c1.04 0 1.07 1.5 1.07 1.5v1.5h-2.4z"/></g></svg>
				</div>
				<div class="title">
					<div class="title-wrapper">
						<span class="title-text" id="title">AS100</span>
					</div>
				</div>
			</div>
		</div>
		<div class="content-body">

			<div class="section-row">
				<div class="section">
					<h2>Потребление (кВт•ч)</h2>
					



					<div class="tabs">
					    <input type="radio" name="inset" value="" id="tab_1" checked>
					    <label for="tab_1">Общее</label>


					    <input type="radio" name="inset" value="" id="tab_2">
					    <label for="tab_2">Период</label>

						<div id="txt_1" class="tabsect">
							<div class="section-body">
								<div id="pies" class="ss">
									<div id="pie" class="sss"></div>
								</div>

								<div class="ss">
									<table class="sss">
										<tr>
											<td class="ssss">
												<element id="en1"></element>
											</td>
											<td>
												<element id="env1"></element>
											</td>
										</tr>
										<tr>
											<td>
												<element id="en2"></element>
											</td>
											<td>
												<element id="env2"></element>
											</td>
										</tr>
										<tr>
											<td>
												<element id="en3"></element>
											</td>
											<td>
												<element id="env3"></element>
											</td>
										</tr>
										<tr>
											<td>
												<element id="en4"></element>
											</td>
											<td>
												<element id="env4"></element>
											</td>
										</tr>
										<tr style='height:50px'>
											<td>
												<element id="ent"></element>
											</td>
											<td>
												<element id="envt"></element>
											</td>
										</tr>  
									</table>
								</div>
							</div>
						</div>



						<div id="txt_2" class="tabsect">
							<div class="section-body" id="pieper">
								<div id="ppies" class="ss">
									<div id="ppie" class="sss"></div>
								</div>

								<div class="ss">
									<table class="sss">
										<tr>
											<td class="ssss">
												<element id="pen1"></element>
											</td>
											<td>
												<element id="penv1"></element>
											</td>
										</tr>
										<tr>
											<td>
												<element id="pen2"></element>
											</td>
											<td>
												<element id="penv2"></element>
											</td>
										</tr>
										<tr>
											<td>
												<element id="pen3"></element>
											</td>
											<td>
												<element id="penv3"></element>
											</td>
										</tr>
										<tr>
											<td>
												<element id="pen4"></element>
											</td>
											<td>
												<element id="penv4"></element>
											</td>
										</tr>
										<tr style='height:50px'>
											<td>
												<element id="pent"></element>
											</td>
											<td>
												<element id="penvt"></element>
											</td>
										</tr>  
									</table>
								</div>
							</div>

							<div class="ss direc">
								<div class="ss">
									<div class="dates">
										<input type="date" id="dfrom">
									</div>
								</div>
								<div class="ss">
									<div class="dates">
										<input type="date" id="dto">
									</div>
								</div>
							</div>
							<div class="ss">
								<div class="dates">
									<button type="submit" onclick = "refreshData(true);">Показать</button>
								</div>
							</div>
						
						</div>
					</div> <!-- #content-region -->



				</div>
			</div>

			<div class="section-row">

				<div class="section">
					<h2>Мощность (Ватт)</h2>
					<div class="section-body">
						<strong id="power"></strong>
					</div>
				</div>

				<div class="section">
					<h2>Напряжение (Вольт)</h2>
					<div class="section-body">
						<strong id="voltage"></strong>
					</div>
				</div>

			</div>

			<div class="section-row">
				<div class="section">
					<h2>График средней мощности</h2>
					<div id="tdata" class="barcht"></div>
					<div id="bar" class="barch"></div>
					<div class="ss">
						<table class="sss" style="display:flex; flex-direction:row; justify-content:center;font-size: 1.4rem; margin-top: -5px; margin-bottom: 10px">
										<tr class="barcht">
											<td>
												<element id="en1">20/11 09:00</element>
											</td>
											<td style="width: 100%;">
												
											</td>
											<td>
												<element id="env1">20/11 22:00</element>
											</td>
										</tr>
						</table>	
					</div>
				</div>
			</div>

		</div>
		<div class="footer"></div>	
	</div>
</body>
</html>

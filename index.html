<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<style>
	html
	{
		color:rgba(0,0,0,0.7);
		font-family:Arial,Helvetica,Sans-Serif;
	}
	body
	{
		margin:0;
		padding:0;
		background-color:#f5f5f5
	}	
	h1,h2
	{
		margin:0;padding:0
	}
	.content
	{
		-moz-user-select: none;
		-khtml-user-select: none;
		user-select: none;
		display:block;
		height:100%
	}
	.header
	{
		height:150px;
		width:100%;
		display:table;
		margin-bottom:3rem;
		box-shadow:0 2px 10px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2);
		position:relative
	}
	.header-body
	{
		vertical-align:middle;
		display:table-cell
	}
	.footer
	{
		height:150px;
	}
	.title
	{
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		justify-content:center;
		text-align:center
	}
	.title-logo
	{
		padding-top:10px;
		display:flex;
		height:50px;
		flex-direction:row;
		flex-wrap:nowrap;
		justify-content:center
	}
	.title-wrapper
	{
		display:table;
	}
	.title-text
	{
		vertical-align:middle;
		display:table-cell;
		font-size:2rem;
		color:#003;
		padding-top:10px
	}
	.content-body
	{
		width:90%;
		height:100%;
		margin:0 auto;
		text-align:center
	}
	.section-row
	{
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		width:100%
	}
	.section
	{
		margin-left:1rem;
		margin-right:1rem;
		flex:1;
		background-color:#fff;
		-webkit-transition:box-shadow .3s ease-in-out 0;
		-moz-transition:box-shadow .3s ease-in-out 0;
		-o-transition:box-shadow .3s ease-in-out 0;
		-ms-transition:box-shadow .3s ease-in-out 0;
		transition:box-shadow .3s ease-in-out 0;
		box-shadow:0 2px 10px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2);
		margin-bottom:2rem
	}
	.section:hover
	{
		box-shadow:0 2px 20px 0 rgba(0,0,0,0.3),0 1px 5px 0 rgba(0,0,0,0.3),0 3px 1px -2px rgba(0,0,0,0.3)
	}
	.section-body
	{
		margin-top:1rem;
		margin-bottom:1rem;
		font-size:1.4rem;
		flex:1;
		background-color:#fff;
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		justify-content:center;
		width:100%
	}
	.ss
	{
		display:flex;
		flex-direction:row;
		justify-content:center;
		margin-left:0.5rem;
		margin-right:0.5rem
	}
	.sss
	{
		display:flex;
		justify-content:center;
		flex-direction:column;
		text-align:left;
		font-weight: bold;
		white-space: nowrap;
	}
	.ssss
	{
		min-width:140px
	}
	.section h2
	{
		padding-top:.5rem;
		padding-bottom:.5rem;
		color:#00a5cd;
		font-weight:400;
		border-bottom:1px solid #f5f5f5
	}
	.conic:hover
	{
		opacity: 0.3;
	}
	.chartBar
	{
		fill:steelblue;
		stroke:black;
		stroke-width:0.1;
		stroke-opacity:0.1;
		display:flex;
		flex-direction:row;
		flex-wrap:nowrap;
		display: flex;
		justify-content:center;
	}
	.barch
	{
		width:100%;
		height:400px;
		font-size:1.4rem;
		fill:#00a5cd
	}
	.barcht
	{
		margin-top: 0.4rem;
		font-size:1.4rem
	}
	@media only screen and (max-width: 600px)
	{
		.section-row
		{
			flex-direction:column;
			flex-wrap:nowrap;
			justify-content:center;
			width:100%
		}
		.section
		{
			flex-direction:column;
		}
		.title-text
		{
			font-size:1.5rem
		}
		.section-body
		{
			font-size: 1.4rem;
			margin-top: 0.2rem;
			margin-bottom:0.2rem;
			flex-direction:column;
			flex-wrap:nowrap;
			width:100%
		}
		.section h2
		{
			font-size:1.0rem
		}
		.barch
		{
			height:200px;
			font-size:0.8rem
		}
		.barcht
		{
			font-size:1.1rem;
		}
	}
	@media only screen and (min-width: 600px) and (max-width: 768px)
	{
		.section h2
		{
			font-size:1.2rem
		}
		.barch
		{
			height:300px;
			font-size:1rem
		}
		.sss
		{
			font-size:1.2rem
		}
			.ssss
		{
			min-width:105px
		}
	}
	</style>

	<title>AS100</title>



	<script type="text/javascript">


		elAttr = {
			width: 'width',
			height: 'height',
			id: 'id',
			class: 'class',
			undefined: 'undefined'
		};

		fnSvgElement = {
			newElement: 'undefined',
			createNewElement: function (element) {
				this.newElement = document.createElementNS("http://www.w3.org/2000/svg", element);
				return this;
			},
			addAttribute: function (key, value) {
				if (this.newElement !== 'undefined')
					this.newElement.setAttribute(key, value);
				else {
					throw Error();
				}
				return this;
			},
			toDomString: function () {
				return this.newElement;
			}
		};

		newObj = {
			bar:function(){
				var b = Object.assign({},elBar);
				return b;
			}
		};

		elUtil = {
			calcTot: function (data) {
				var tot = data.reduce(function (previousValue, currentValue) {
					return previousValue + currentValue;
				});
				return tot;
			},
			getPosition: function (el) {
				var rect = el.getBoundingClientRect(),
						scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
						scrollTop = window.pageYOffset || document.documentElement.scrollTop;
				return {x: rect.top + scrollTop, y: rect.left + scrollLeft};
			},
			getSubArray:function(arr,start,end) {
				return arr.slice(start,end+1);
			}
		};

		elStats = {
			calcRangeOnNonSortedData: function (arr) {
				arr.sort(function(a,b){
					return a-b;
				});
				var len = arr.length;
				var range = (arr[len-1] - arr[0]) / (len-1);
				return Math.ceil(range);
			}
		};

		set = {
			bar: function(x,y,id,barWidth,barHeight,barClass) {
				var bar = fnSvgElement.createNewElement('rect')
						.addAttribute('x', x)
						.addAttribute('y', y)
						.addAttribute('id', id)
						.addAttribute('width', barWidth)
						.addAttribute('height', barHeight)
						.addAttribute('class', barClass)
						.toDomString();
				return bar;
			}
		};

		function generateArcSector(svg, cX, cY, radius, datum, colour, iniA, endA, sweep) {
			cX = parseFloat(cX);
			cY = parseFloat(cY);
			radius = parseFloat(radius);
			iniA = parseFloat(iniA);
			var x1 = cX + radius * Math.cos((iniA) * Math.PI / 180);
			var y1 = cY + radius * Math.sin((iniA) * Math.PI / 180);

			var x2 = cX + radius * Math.cos((endA) * Math.PI / 180);
			var y2 = cY + radius * Math.sin((endA) * Math.PI / 180);


			var path = 'M' + cX + ' ' + cY +   ' L' + x1 + ' ' + y1 +	' A' + radius + ' ' + radius + ', 0, ' + sweep + ', 1, ' + x2 + ' ' + y2 + ' z';
			var pathNode = fnSvgElement.createNewElement('path')
					.addAttribute('d', path)
					.addAttribute('stroke-width', '0.1')
					.addAttribute('class', 'conic')
					.addAttribute('stroke', 'black')
					.addAttribute('fill', colour)
					.toDomString();
			var title = fnSvgElement.createNewElement('title').toDomString();
			title.textContent = datum + '%';
	 		pathNode.appendChild(title);

	 		svg.appendChild(pathNode);
		}

		elException = {
			generalCheck: function (actual, expected) {
				if (actual === expected) {
					return !0;
				} else {
					return !1;
				}
			},
			checkId: function (id) {
				if (this.generalCheck(id, null)) {
					throw Error();
				} else {
					return !0;
				}
			},
			checkObject: function (obj) {
				if (this.generalCheck(obj, elAttr.undefined)) {
					throw Error();
				} else {
					return !0;
				}
			}
		};

		elPie = {
			svgObject: 'undefined',
			properties: {
				width: '',
				height: '',
				data: [],
				colours: []
			},
			create: function (eleId) {
				var div = document.getElementById(eleId);
				if (elException.checkId(div)) {
					this.svgObject = fnSvgElement.createNewElement('svg')
				   			.addAttribute('width', this.properties.width)
							.addAttribute('height', this.properties.height)
							.toDomString();
					div.appendChild(this.svgObject);
					return this;
				} else {
					throw Error();
				}
			},
			generate: function () {
				var ht = parseInt(this.properties.height);
				var wt = parseInt(this.properties.width);
				var tot = elUtil.calcTot(this.properties.data);
				var radius = 0.9* (2*ht) / 4;
				var len = this.properties.data.length;
				var iniA = 0;
				var endA = 0;
				var cx = wt / 2;
				var cy = ht / 2;
				var sweep, d, v;
				gobj = fnSvgElement.createNewElement('g').toDomString();

				for (var i = 0; i < len; i++) {
					d = this.properties.data[i];

					v = ((360 * d) / tot);
					if (v > 359.999) v = 359.999;
					//console.log(i, v);

					endA = iniA + v;
					
					if (d > (tot / 2)) sweep = 1;
			   		else sweep = 0;

					generateArcSector(gobj, cx, cy, radius, (d/tot*100).toFixed(3), this.properties.colours[i], iniA, endA, sweep);


					//generateArcSector(gobj, cx, cy, radius, (this.properties.data[i]/tot*100).toFixed(3), this.properties.colours[i], iniA, endA, sweep);



					iniA = endA;

				}
				this.svgObject.appendChild(gobj);
			},
			attribute: function (attr, value) {
				elException.checkObject(this.svgObject);
				this.properties[attr] = value;
				this.svgObject.setAttribute(attr, value);
				return this;
			},
			data: function (dt) {
				elException.checkObject(this.svgObject);
				this.properties.data = dt;
				this.generate();
				return this;
			}
		};

		svg = {
			svgObj: 'undefined',
			generate: function (height, width) {
				this.svgObj = fnSvgElement.createNewElement('svg')
						.addAttribute('width', width)
						//.addAttribute('height', height)
						//.addAttribute('preserveAspectRatio', "none") ???
						.addAttribute('class', 'barch')
						.toDomString();
				return this.svgObj;
			}
		};

		axis = {
			props: {
				'SX': 0,
				'SY': 0,
				'OX': 0,
				'OY': 0,
				'EX': 0,
				'EY': 0,
				'LOX': 0,
				'': '',
				'xdataRotation': 90,
				'xCords': [],
				'yCords': [],
				'yAxPos': [],
				'baseUnit' : 0
			},
			generateAxis: function (level, color, text) {
				var yPath = pathG.move(this.props.OX, this.props.OY-level) + ' ' + pathG.lineTo(this.props.EX, this.props.EY-level);
				pathObj = fnSvgElement.createNewElement('path')
						.addAttribute('d', yPath)
						.addAttribute('stroke-width', '1')
						.addAttribute('stroke', color)
						.toDomString();
				this.props.svg.appendChild(pathObj);
				if(text) {
					var titlet = fnSvgElement.createNewElement('text')
												.addAttribute('x', this.props.OX)
												.addAttribute('y', this.props.OY-level-5)
												.addAttribute('class', 'barch')
												.toDomString();
												titlet.textContent = this.props.yAxPos + ' Вт';
					this.props.svg.appendChild(titlet);
				}
			},
			calculateAxis: function (width, height) {
				
				var startX = this.props.SX = 0.05*width;
				var startY = this.props.SY = 0.08*height;
				this.props.OX = startX;
				var oY = this.props.OY = height - 0.1*height;
				var endX = this.props.EX = width - startX;
				this.props.EY = oY;
				this.props.LOX = endX - startX;

				var ycords = this.props.yCords;
				var length = ycords.length;
				var range = elStats.calcRangeOnNonSortedData(ycords);
				var max = Math.ceil(ycords[length - 1]);
				this.props.yAxPos = max;
				//console.log(max, range);
				var a_diff = (oY - startY) / (max / range);
				//console.log("a_diff",a_diff);
				this.props.aDiff = a_diff/range;
				//console.log("this.props.aDiff",this.props.aDiff);
			},
			generateSimpleAxis: function (svgObj, xcords, ycords, yticks, xdataR, height, width) {
				width = document.getElementById("bar").clientWidth;
				height = document.getElementById("bar").clientHeight;
				this.props.svg = svgObj;
				this.props.xCords = xcords;
				this.props.yCords = ycords;
				this.props.xdataRotation = xdataR;
				this.calculateAxis(width, height);
				this.generateAxis(0, 'black');
				for (var i = 4; i > 0; i--) {
					this.generateAxis(this.props.yAxPos*i*this.props.aDiff/4, '#00a5cd', !(i%4))
				}
			}
		};

		pathG = {
			move: function (x, y) {
				return 'M' + x + ',' + y;
			},
			lineTo: function (x, y) {
				return 'L' + x + ',' + y;
			},
			completePath: function () {
				return 'z';
			}
		};

		chart = {
			pie: function (id, props) {
				for (var i in props) {
					elPie.properties[i] = props[i];

				}
				elPie.create(id);
				elPie.generate();
			},
			bar: function (id, props) {
				var bar = newObj.bar();
				
				for (var i in props) {
					bar.props[i] = props[i];
				}
				bar.generate(id);
			}
		};

		var barprops = {			
			'data': [],
			'xCords': [],
			'yCords': [],
			'yCordsSorted': [],
			'datumsPerScreen': 12,
			'colours': {},
			'barColours': '',
			'yTickLabels': {},
			'start': 36, // hardcoded draw area (48-datumsPerScreen)
			'svgObj': 'undefined',
			'axisType': 'generateSimpleAxis'
		};

		elBar = {
			props: {
				'width': 0,
				'height': 0,
				'data': [],
				"time": 0,
				'xCords': [],
				'yCords': [],
				'yCordsSorted': [],
				'datumsPerScreen': 4,
				'colours': {},
				'barColours': 'blue',
				'yTickLabels': {},
				'svgObj': 'undefined',
				'prevBar': 'undefined',
				'axisType': 'generateSimpleAxis',
				'aProps': {},
				'prevPos': 0,
				'start':0,
				'end':0,
				'length':0,
				'groupBar':'undefined'
			},
			removeBars:function() {
				var group = document.getElementsByClassName('bargroup')[0];
			},
			dragSvg : function(event) {
				if(event.buttons!=0) {
					var presentPos;
					if ('ontouchstart' in window)
						presentPos = event.touches[0].clientX; 
					else
						presentPos = event.screenX;

					//console.log("PrevPos", this.props.prevPos, "presentPos", presentPos);
					if(this.props.prevPos!=0) {

						var diff = (presentPos-this.props.prevPos);
						//console.log(diff);
						if(diff<-6&&this.props.start+this.props.datumsPerScreen<this.props.length) {
							this.props.start = this.props.start+1;
							this.props.end = this.props.end+1;
							this.props.svgObj.removeChild(this.props.groupBar);
							this.generateBars(this.props.start+1,this.props.start+this.props.datumsPerScreen);
							//console.log("GenBars(<-):",barprops.start, "to", barprops.start+this.props.datumsPerScreen, "  diff:", diff);
							this.props.prevPos = presentPos;
						}
						if(diff>6&&this.props.start>0) {
							this.props.start= this.props.start-1;
							this.props.end = this.props.end-1;
							this.props.svgObj.removeChild(this.props.groupBar);
							this.generateBars(this.props.start+1,this.props.start+this.props.datumsPerScreen);
							//console.log("GenBars(->):",barprops.start, "to", barprops.start+this.props.datumsPerScreen, "  diff:", diff);
							this.props.prevPos = presentPos;
						}
					}
					else
						this.props.prevPos = presentPos;
					barprops.start = this.props.start;
					barprops.end = this.props.end;
				}
			},
			mousedown : function(event) {
				//this.props.down=true;
				if ('ontouchstart' in window)
					this.props.prevPos = event.touches[0].clientX;
				else
					this.props.prevPos = event.screenX;
				return false;
			},
			ttShow : function(event) {
				var t = event.target;
				var td = document.getElementById("tdata");
				td.textContent = t.firstChild.textContent;
				t.style.fill = '#F2635F';
				try {
					if(this.props.prevBar != t) {
						//this.props.prevBar.style.fill = 'steelblue';
						this.props.prevBar.setAttribute("style", "fill:steelblue;");
						//console.log('new style');
					}

				}
				catch (e) {
					//console.log("2!");
				}
				
				this.props.prevBar = t;
				// UBERACHTUNG!!!! суперкостыль
				document.getElementById("bar").innerHTML = "";
				chart.bar('bar', barprops);
			},
			generateBars : function(start,end) {
				var LOX = this.props.aProps.LOX;
				var oX =  this.props.aProps.OX;
				var oY =  this.props.aProps.OY;
				var bps = end-start+1;
				var svg = this.props.svgObj;
				var barWidth =  3*LOX/(4*bps);
				var distBtwBar = LOX/(4*bps);
				var x = oX+distBtwBar/2;
				var y = oY;
				var group = fnSvgElement.createNewElement('g')
							.addAttribute('class','bargroup')
							.addAttribute('onmousedown','return false;')
							.addAttribute('ondragstart','return false;')
							.addAttribute('ondrop','return false;')
							.toDomString();

				for(var i=start;i<=end;i++) {
					var barHeight = ((parseInt(this.props.yCords[i-1])-this.props.aProps.baseUnit)*this.props.aProps.aDiff);
					barPosition = oY-barHeight;
					var bar = set.bar(x,barPosition,'b'+i,barWidth,barHeight,'chartBar');

					if(bar.id == this.props.prevBar.id) {
						bar.style.fill = '#F2635F';
					}
				

					/*var titlet = fnSvgElement.createNewElement('text')
											.addAttribute('id','tt'+i )
											.addAttribute('x', x)
											.addAttribute('y', barPosition)
											.addAttribute('position', 'relative')
											.addText(this.props.xCords[i-1] + ' - ' + this.props.yCords[i-1] + ' Вт')
											.addAttribute('class','tooltip')
											.addAttribute('font-family','Arial')
											.addAttribute('font-size',20)
											.addAttribute('visibility','hidden')
											.toDomString();*/

					
					var title = fnSvgElement.createNewElement('title').toDomString();
					title.textContent = this.props.xCords[i-1] + ' - ' + this.props.yCords[i-1] + ' Вт';
					bar.appendChild(title);

			 		//group.appendChild(titlet);

					bar.addEventListener('mousedown', this.ttShow.bind(this));
					//"var tt = document.getElementById(\"tt"+i+"\"); tt.style.x = event.screenX; tt.style.y = event.screenY;tt.style.visibility='visible';"); // this.firstChild.style.visibility='visible'


			 		group.appendChild(bar);

			 		x=x+barWidth+distBtwBar;
				}

				

				this.props.groupBar = group;
				svg.appendChild(group);
			},
			generate: function (id, properties) {
				delete document.getElementById(id);
				for (var i in properties) {
					this.props[i] = properties[i];
				}
				var data = this.props['data'];
				var xCords = [];
				var yCords = [];

				var d = new Date(this.props['time']*1000);
				d.setMinutes( Math.floor(d.getMinutes()/30)*30 );
				d.setDate(d.getDate() - 1);

				for ( var i = 0; i < data.length; i++ ) {


					var hours1 = d.getHours();
					var minutes1 =  parseInt( ("0" + d.getMinutes()).substr(-2) );

					d.setMinutes(d.getMinutes() + 30);
					
					var hours = d.getHours();
					var minutes =  parseInt( ("0" + d.getMinutes()).substr(-2) );


					xCords.push("с " + hours1 + ":" + (minutes1>0 ? minutes1 : "00") + " по " + hours + ":" + (minutes>0 ? minutes : "00"));
					yCords.push(data[i]*2);

					
				}
				this.props.xCords = xCords;
				this.props.yCords = yCords;
				this.props.length = yCords.length;
				this.props.yCordsSorted = Object.assign([],yCords);
				this.props.svgObj = svg.generate(this.props.height, this.props.width);
				window['axis'][this.props.axisType](this.props.svgObj, xCords, this.props.yCordsSorted,[],0, this.props.height, this.props.width); 
				document.getElementById(id).appendChild(this.props.svgObj);
				this.props.aProps = axis.props;
				this.generateBars(barprops.start+1, barprops.start+this.props.datumsPerScreen);
				//this.props.start=barprops.start+1;
				//console.log(barprops.start, "to", barprops.start+this.props.datumsPerScreen);
				this.props.end=this.props.datumsPerScreen;
				this.props.svgObj.addEventListener('mousemove',this.dragSvg.bind(this));
				this.props.svgObj.addEventListener('mousedown',this.mousedown.bind(this));
				if ('ontouchstart' in window) {
					this.props.svgObj.addEventListener('touchmove',this.dragSvg.bind(this));
					this.props.svgObj.addEventListener('touchstart',this.mousedown.bind(this));
				}
			}
		}; 



		var error_counter = 0;
		var req_counter = 999999;
		var needBar = false;

		String.prototype.format = function() {
			var formatted = this;
			for( var arg in arguments )
				formatted = formatted.replace("{" + arg + "}", arguments[arg]);

			return formatted;
		};

		function get_data(success, success1, error, timeout) {
			
			if(!needBar) {
				var xmlhttp = new XMLHttpRequest();

				xmlhttp.open('GET', rs+"get", true);

				xmlhttp.timeout = timeout || 2000;

				xmlhttp.onreadystatechange = function() {
					if (xmlhttp.readyState == XMLHttpRequest.DONE) {
						if(xmlhttp.status == 200) {
							try {
								success(JSON.parse(xmlhttp.responseText));
								/*success(JSON.parse( "{\"SN\":\"TEST0000\", \"T\":1508430088, \"A1\":4455.001, \"A2\":45455.100, \"A3\":155455.100, \"A4\":565461.100,\"P\":123.65, \"U\":220.14 }" ));*/
							}
							catch (E) {
								error("Fail to parse json get");
								console.log("Fail to parse json get");
							}
						}
						else {
							error(xmlhttp.responseText);
							console.log("xmlhttp", xmlhttp.responseText);
						}

					}
				};
			
				xmlhttp.send(null);
			}

			
			else {
				var xmlhttp1 = new XMLHttpRequest();

				xmlhttp1.open('GET', rs+"lp", true);

				xmlhttp1.timeout = timeout || 2000;

				xmlhttp1.onreadystatechange = function() {
					if (xmlhttp1.readyState == XMLHttpRequest.DONE) {
						if(xmlhttp1.status == 200) {
							try {
								success1(JSON.parse(xmlhttp1.responseText));
								needBar = false;
								/*success1(JSON.parse( "{\"lp\":[5, 2, 34, 4, 33, 0.5, 5, 6, 2, 23, 5, 6, 2, 5, 6, 9, 9, 5, 1, 9, 10, 1, 1, 5, 1, 4, 5, 6, 2, 3, 5, 6, 2, 5, 6, 9, 9, 5, 1, 5, 8.451, 23.2, 3, 4, 35.1, 4, 5, 12]}" ));
								needBar = false;*/
							}
							catch (E) {
								error("Fail to parse json lp");
								console.log("Fail to parse json lp");
							}
						}
						else {
							error(xmlhttp1.responseText);
							console.log("xmlhttp1", xmlhttp1.responseText);
						}

					}
				};

				xmlhttp1.send(null);		
			}
		}

		function refreshData()
		{
			get_data(
				function(data) {
					error_counter = 0;
					req_counter++;
					if(req_counter > 29) {
						needBar = true;
						req_counter = 0;
					}
					document.getElementById("title").innerHTML="AS100 (#{0})".format(data.SN);

					var T1 = parseFloat(data.A1);
					var T2 = parseFloat(data.A2);
					var T3 = parseFloat(data.A3);
					var T4 = parseFloat(data.A4);

					var pp = {
						'width': 260,
						'height': 260,
						'data': [],
						'colours': ['#ff8678', '#ffbf00', '#4ec7ff', '#6ee7ff']
					};

					if(!isNaN(T1)) pp.data.push(T1);
					if(!isNaN(T2)) pp.data.push(T2);
					if(!isNaN(T3)) pp.data.push(T3);
					if(!isNaN(T4)) pp.data.push(T4);
					
					barprops.time = parseInt(data.T);

					if(pp.data.length > 1)
					{
						var sum = 0;
						for (var i = 0; i < pp.data.length; i++) {
							sum += pp.data[i];
							document.getElementById("en" + (i+1).toString()).innerHTML  = "<span style='color:"+pp.colours[i]+"'>■</span> Тариф "+(i+1).toString()+":";
							document.getElementById("env" + (i+1).toString()).innerHTML  = "{0}".format(pp.data[i].toFixed(1).toString());
						}

						document.getElementById("pie").innerHTML = "";
						chart.pie('pie', pp);
						document.getElementById("et").innerHTML  = "Сумма:";
						document.getElementById("envt").innerHTML  = "{0}".format(sum.toFixed(1).toString());

					}
					else
					{	try {
							el = document.getElementById("pies");
							el.parentNode.removeChild(el);
						} catch (e) {
							//console.log("1!");
						}
						document.getElementById("envt").innerHTML = T1.toString();
					}
					
					document.getElementById("power").innerHTML	= data.P.toFixed(1).toString();
					document.getElementById("voltage").innerHTML  = data.U.toFixed(1).toString();

					setTimeout(refreshData, 2000);
					
				},
				function(data) {
					error_counter = 0;
					barprops.data = data.lp;
					document.getElementById("bar").innerHTML = "";
					chart.bar('bar', barprops);

					setTimeout(refreshData, 2000);
				},
				function(error) {
					if (error_counter > 3)
					{
						document.getElementById("title").innerHTML="AS100 (Нет cвязи)"; 
						document.getElementById("envt").innerHTML  = "";
						document.getElementById("env1").innerHTML  = "";
						document.getElementById("env2").innerHTML  = "";
						document.getElementById("env3").innerHTML  = "";
						document.getElementById("env4").innerHTML  = "";
						document.getElementById("ent").innerHTML  = "";
						document.getElementById("en1").innerHTML  = "";
						document.getElementById("en2").innerHTML  = "";
						document.getElementById("en3").innerHTML  = "";
						document.getElementById("en4").innerHTML  = "";
						document.getElementById("pie").innerHTML  = "";
						document.getElementById("tdata").innerHTML  = "";
						document.getElementById("bar").innerHTML  = "";
						document.getElementById("power").innerHTML	= "";
						document.getElementById("voltage").innerHTML  = "";
					}
					else
					{
						error_counter += 1;
					}
					
					setTimeout(refreshData, 3000);
				},
				2000
			);
			//elBar.mouseup();
		}

		

		window.onload = function()
		{
			setTimeout(refreshData, 2000);
		};

		window.onresize = function()
		{
			var cb = document.getElementById("bar").innerHTML = "";
			chart.bar('bar',cb.barprops);
		}

		

	</script>
</head>

<body>
	<div class="content">
		<div class="header">
			<div class="header-body">
				<div class="title-logo">
					<img class="figure" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA3Ny41OSAxNC42NSI+PGcgZmlsbD0iI2IwMTg0MiI+PHBhdGggZD0iTTM5LjYzIDcuMjNjMC0yLjUtMS44OC00LjUyLTQuNDgtNC41M2gtLjAyYy0yLjYgMC00LjQ2IDIuMTUtNC40NiA0LjY2IDAgMi41IDEuODQgNC40OCA0LjQ2IDQuNDggMiAwIDQuMTctLjkgNC40NS0yLjc0aC0xLjU1Yy0uMzIgMi4xLTQuMDIgMi4wNy00LjE1LjA1LS4wMi0uMzQtLjAyLTEuMjctLjAyLTEuMjdoNS44Yy4wMi0uMTctLjAzLS40Ni0uMDMtLjY1em0tNS43NC0uNVY1LjJzMC0xLjQgMS4yLTEuNGMxIDAgMS4xIDEuNDcgMS4xIDEuNDd2MS41aC0yLjN6TTY5LjkgMGgzLjIzdjExLjQzSDcwem00LjM4IDBoMy4yNHYxMS40M0g3NC4zek0xNS40IDIuN2MtMS42NCAwLTQuNyAxLjE2LTQuNyA0LjYuMDIgMy44IDMuMDYgNC41NCA0LjcgNC41NCAxLjY0IDAgNC43LS45NiA0LjctNC41NS0uMDItMy42LTMuMDYtNC42LTQuNy00LjZ6bTAgOC4wM2MtLjkgMC0xLjIyLTEuMzYtMS4yMi0zLjQzIDAtMi4wOC4xOC0zLjQ3IDEuMjItMy40Ny45OCAwIDEuMTggMS40IDEuMTggMy40NyAwIDIuMDctLjIgMy40My0xLjE4IDMuNDN6TTAgMGgzLjV2NC43aDIuNzJWMGgzLjd2MTEuNDNINi4yVjYuNEgzLjV2NS4wNUgwVjBtMjEuMDggMTEuNDN2LTguNGgzLjJ2LjhzMS4xNS0uOTYgMi41NC0uOTZjMS4zIDAgMi41LjkgMi43NiAxLjkyLjA4LjMuMDYuNi4wNi42djZIMjYuNVY1LjlzLjEyLTEuMjUtLjg0LTEuMmMtLjc2LjA0LTEuMjYuNDQtMS40Ljd2Ni4wNUgyMS4xIi8+PHBhdGggZD0iTTM4Ljg0IDEyLjhjMCAuNzUuNDQgMS44NSAxLjg1IDEuODUgMS4xIDAgMi4yLS42NiAyLjYtMS41N2w0LTEwLjA0IDIuNCA4LjRoMi42M0w1My43IDYuNGwxLjYgNS4xaDIuNUw2MCAzLjFoLTEuNGwtMS4xNiA0LjQtMS41LTQuNGgtMi42bC0xLjMgNC41LTEuMzMtNC41M2gtNC42TDQ0LjUgNy4xbC0xLjU0LTQuMDVoLTMuN3MzLjQyIDcuOCAzLjQgOC40Yy0uMDQgMS4zOC0xLjEgMi0xLjI0IDIuMDVoLjAyYy4xMi0uMTcuMjMtLjUuMjMtLjc4IDAtLjc3LS42Mi0xLjQtMS40LTEuNC0uNzcgMC0xLjQuNjQtMS40IDEuNDhNNjkuMiA3LjIzYzAtMi41LTEuOS00LjUyLTQuNS00LjUzLTIuNiAwLTQuNDYgMi4xNS00LjQ2IDQuNjYgMCAyLjUgMS44NCA0LjQ4IDQuNDYgNC40OCAxLjk4IDAgNC4xNi0uOSA0LjQ0LTIuNzRINjcuNmMtLjMzIDIuMS00LjAzIDIuMDctNC4xNi4wNS0uMDItLjM0LS4wMi0xLjI3LS4wMi0xLjI3aDUuOGMuMDItLjE3LS4wMy0uNDYtLjAzLS42NXptLTUuNzQtLjVsLjA2LTEuNTJzMC0xLjQgMS4yLTEuNGMxLjA0IDAgMS4wNyAxLjUgMS4wNyAxLjV2MS41aC0yLjR6Ii8+PC9nPjwvc3ZnPg=="></img>
				</div>
				<div class="title">
					<div class="title-wrapper">
						<span class="title-text" id="title">AS100</span>
					</div>
				</div>
			</div>
		</div>
		<div class="content-body">
			<div class="section-row">
				<div class="section">
					<h2>Потребление (кВт•ч)</h2>
					<div class="section-body">

						<div id="pies" class="ss">
							<div id="pie" class="sss"></div>
						</div>

						<div class="ss">
							<table class="sss">
								<tr>
									<td class="ssss">
										<element id="en1"></element>
									</td>
									<td>
										<element id="env1"></element>
									</td>
								</tr>
								<tr>
									<td>
										<element id="en2"></element>
									</td>
									<td>
										<element id="env2"></element>
									</td>
								</tr>
								<tr>
									<td>
										<element id="en3"></element>
									</td>
									<td>
										<element id="env3"></element>
									</td>
								</tr>
								<tr>
									<td>
										<element id="en4"></element>
									</td>
									<td>
										<element id="env4"></element>
									</td>
								</tr>
								<tr style='height:50px'>
									<td>
										<element id="et"></element>
									</td>
									<td>
										<element id="envt"></element>
									</td>
								</tr>  
							</table>
						</div>

					</div>
				</div>
			</div>
			<div class="section-row">

				<div class="section">
					<h2>Мощность (Ватт)</h2>
					<div class="section-body">
						<strong id="power"></strong>
					</div>
				</div>

				<div class="section">
					<h2>Напряжение (Вольт)</h2>
					<div class="section-body">
						<strong id="voltage"></strong>
					</div>
				</div>

			</div>

			<div class="section-row">
				<div class="section">
					<h2>График средней мощности</h2>
					<div class="barcht">
						<strong id="tdata"></strong>
					</div>
						<div id="bar" class="barch"></div>
				</div>
			</div>

		</div>
		<div class="footer"></div>	
	</div>
</body>
</html>
